@typeparam TModel

@if (Core.Status == LoadingStatus.Loading)
{
    if (PartialComponent)
    {
        <Blazorise.Text TextColor="TextColor.Secondary">
            <Blazorise.Icon Class="spinner-border spinner-border-sm"></Blazorise.Icon> @MessageLoading
        </Blazorise.Text>
    }
    else
    {
        <Alert Color="Color.Warning" Visible="true">
            <AlertDescription>
                <Blazorise.Icon Class="spinner-border spinner-border-sm"></Blazorise.Icon> @MessageLoading
            </AlertDescription>
        </Alert>
    }
}
else if (Core.Status == LoadingStatus.Locked && !PartialComponent)
{
    <Alert Color="Color.Primary" Visible="true">
        <AlertDescription>
            <Blazorise.Icon Name="FontAwesomeIcons.UserLock"></Blazorise.Icon> @GlobalTranslations.UnauthenticatedUser
        </AlertDescription>
    </Alert>
}
else if (Core.Status == LoadingStatus.Error && !PartialComponent)
{
    <Alert Color="Color.Danger" Visible="true">
        <AlertDescription>
            <Blazorise.Icon Name="FontAwesomeIcons.Bug"></Blazorise.Icon> @(MessageError ?? @GlobalTranslations.CustomVisibilityInvalid)
        </AlertDescription>
    </Alert>
}
else if (Core.Status == LoadingStatus.Warning && !PartialComponent)
{
    <Alert Color="Color.Primary" Visible="true">
        <AlertDescription>
            <Blazorise.Icon Name="FontAwesomeIcons.ExclamationTriangle"></Blazorise.Icon> @(MessageWarning ?? @GlobalTranslations.CustomVisibilityNoData)
        </AlertDescription>
    </Alert>
}
else //ShowContent
{
    @ChildContent
}

@code {
    [CascadingParameter] protected Task<AuthenticationState>? authenticationState { get; set; }

    [Parameter][EditorRequired] public RenderFragment ChildContent { get; set; } = default!;
    [Parameter][EditorRequired] public RenderControlCore<TModel> Core { get; set; } = default!;
    [Parameter][EditorRequired] public TModel? Model { get; set; }
    [Parameter][EditorRequired] public Func<TModel?, bool> ExpressionEmpty { get; set; } = default!;

    [Parameter] public bool PrivateContent { get; set; } = false;
    [Parameter] public string? CustomMessageError { get; set; } = null;
    [Parameter] public string? CustomMessageWarning { get; set; } = null;
    [Parameter] public bool PartialComponent { get; set; } = false;

    private string? MessageLoading { get; set; } = GlobalTranslations.CustomVisibilityLoading;
    private string? MessageError { get; set; } = null;
    private string? MessageWarning { get; set; } = null;

    protected override void OnInitialized()
    {
        ArgumentNullException.ThrowIfNull(ChildContent);
        ArgumentNullException.ThrowIfNull(Core);
        ArgumentNullException.ThrowIfNull(ExpressionEmpty);

        if (Model != null && (ExpressionEmpty != null && !ExpressionEmpty(Model)))
            Core.Status = LoadingStatus.ShowContent;

        Core.LoadingStarted += () => ShowLoading();
        Core.LoadingFinished += (TModel? model) => ShowContent(model);
        Core.ProcessingStarted += () => ShowLoading("Processing...");
        Core.ProcessingFinished += (TModel? model) => ShowContent(model);
        Core.WarningAction += (string? msg) => ShowWarning(msg);
        Core.ErrorAction += (string? msg) => ShowError(msg);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        ArgumentNullException.ThrowIfNull(Core);

        await base.OnAfterRenderAsync(firstRender);

        if (firstRender && PrivateContent && authenticationState is not null)
        {
            var authState = await authenticationState;
            var user = authState?.User;
            var isAuthenticated = user?.Identity is not null && user.Identity.IsAuthenticated;

            if (!isAuthenticated)
            {
                Core.Status = LoadingStatus.Locked;
            }
        }
    }

    private void Reset()
    {
        MessageError = null;
        MessageWarning = null;

        StateHasChanged();
    }

    private void ShowLoading(string? msg = null)
    {
        Reset();

        Core.Status = LoadingStatus.Loading;
        MessageLoading = msg ?? GlobalTranslations.CustomVisibilityLoading;

        StateHasChanged();
    }

    private void ShowContent(TModel? model)
    {
        Reset();

        if (PartialComponent)
        {
            Core.Status = LoadingStatus.ShowContent;
            StateHasChanged();
            return;
        }

        if (Core.Status == LoadingStatus.Error | Core.Status == LoadingStatus.Warning) return;

        if (model == null || (ExpressionEmpty != null && ExpressionEmpty(model)))
            Core.Status = LoadingStatus.Warning;
        else
            Core.Status = LoadingStatus.ShowContent;

        StateHasChanged();
    }

    /// <summary>
    ///
    /// </summary>
    /// <param name="msg">Default: no data</param>
    private void ShowWarning(string? msg)
    {
        Reset();

        Core.Status = LoadingStatus.Warning;
        MessageWarning = CustomMessageWarning ?? msg;

        StateHasChanged();
    }

    /// <summary>
    ///
    /// </summary>
    /// <param name="msg">Default: invalid operation</param>
    private void ShowError(string? msg)
    {
        Reset();

        Core.Status = LoadingStatus.Error;
        MessageError = CustomMessageError ?? msg;

        StateHasChanged();
    }
}