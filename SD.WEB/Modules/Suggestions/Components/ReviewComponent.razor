@using SD.Shared.Models.Reviews;
@using SD.WEB.Modules.Suggestions.Core;

@inherits ComponenteCore<ReviewComponent>

@inject ExternalIdApi ExternalIdApi
@inject CacheApi CacheApi

<RenderControl Task="LoadReview">
    <ListGroup Flush>
        @foreach (var item in Model?.Items ?? new())
        {
            <ListGroupItem Padding="Padding.Is2">
                <Heading Size="HeadingSize.Is6" Margin="Margin.Is1.FromBottom">
                    <Badge Color="GetColorByRating(item?.score)" Margin="Margin.Is2.FromEnd">@item?.score</Badge> @(item?.reviewSite + (string.IsNullOrEmpty(item?.reviewer) ? "" : " | " + item?.reviewer))
                </Heading>
                <Small TextAlignment="TextAlignment.Justified">@item.quote</Small>
                <Blazorise.Link To="@item.reviewUrl" Target="Target.Blank" Style="font-size: 80%;">Read full review</Blazorise.Link>
            </ListGroupItem>
        }
    </ListGroup>
</RenderControl>

@code {
    [Parameter] public string? imdb_id { get; set; }
    [Parameter] public string? title { get; set; }
    [Parameter] public string? original_title { get; set; }
    [Parameter] public DateTime? release_date { get; set; }
    [Parameter] public MediaType? type { get; set; }

    public ReviewModel? Model { get; set; }

    protected async Task<bool> LoadReview()
    {
        if (!string.IsNullOrEmpty(imdb_id))
        {
            //TODO: must be english_title, not original_title
            if (type == MediaType.movie)
            {
                var cache = await CacheApi.GetMovieReviews(imdb_id, original_title, release_date);

                Model = (ReviewModel?)cache?.Data;
            }
            else
            {
                var cache = await CacheApi.GetShowReviews(imdb_id, original_title, release_date);

                Model = (ReviewModel?)cache?.Data;
            }
        }

        return Model == null || !Model.Items.Any();
    }

    private Color GetColorByRating(int? val)
    {
        if (!val.HasValue) return Color.Secondary;

        if (val > 10) val = val / 10;

        if (val >= 8)
        {
            return Color.Success;
        }
        else if (val >= 6)
        {
            return Color.Warning;
        }
        else
        {
            return Color.Danger;
        }
    }
}
