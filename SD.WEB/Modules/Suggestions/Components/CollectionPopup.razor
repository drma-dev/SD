@using SD.Shared.Models.List.Tmdb;
@using SD.WEB.Modules.Profile.Core;
@using SD.WEB.Modules.Suggestions.Core;
@inherits ComponenteCore<CollectionPopup>

@inject TmdbApi TmdbApi
@inject WatchedListApi WatchedListApi
@inject WatchingListApi WatchingListApi

<ModalHeader>
    <ModalTitle Size="HeadingSize.Is5">@collection?.name</ModalTitle>
    <CloseButton />
</ModalHeader>
<ModalBody MaxHeight="70">
    <RenderControl Task="Loadcollection">
        <Row HorizontalGutter="4" VerticalGutter="4" Margin="Margin.Is1.FromBottom">
            @foreach (var item in collection?.parts.OrderBy(o => o.release_date.GetDate()) ?? Enumerable.Empty<Part>())
            {
                <Column ColumnSize="ColumnSize.Is4.OnMobile.Is3.OnWidescreen.Is2.OnFullHD">
                    <Card>
                        <Blazorise.Link Clicked="@(async() => await CollectionClicked(item))" Style="position: relative;">
                            @{
                                var release_date = item.release_date.GetDate();
                            }
                            @if (release_date.HasValue)
                            {
                                if (release_date.Value < DateTime.Now.AddMonths(-3))
                                {
                                    <Badge Color="Color.Light" TextColor="TextColor.Dark" Padding="Padding.Is1" Style="font-size: 10px; position: absolute; top: 3px; left: 3px; z-index: 1;">@release_date.Value.Year</Badge>
                                }
                                else
                                {
                                    <Badge Color="Color.Light" TextColor="TextColor.Dark" Padding="Padding.Is1" Style="font-size: 10px; position: absolute; top: 3px; left: 3px; z-index: 1;">@release_date.Value.ToShortDateString()</Badge>
                                }
                            }
                            @if (string.IsNullOrEmpty(item.poster_path))
                            {
                                <CardImage Source="images/noimage.png" Alt="@item.title" title="@item.title" Style="cursor: pointer;"></CardImage>
                            }
                            else
                            {
                                if (type == MediaType.movie) //you don't put seasons as wishes
                                {
                                    var wishedMovie = WishList?.Contains(MediaType.movie, item.id.ToString()) ?? false;
                                    if (wishedMovie)
                                    {
                                        <Blazorise.Icon Name="FontAwesomeIcons.Bookmark" IconSize="IconSize.x2" TextColor="TextColor.Light"
                                                        Style="position: absolute; bottom: 5px; left: 5px; z-index: 1;"></Blazorise.Icon>
                                    }
                                }

                                var watched = WatchingList?.GetWatchedItems(type, collection?.id.ToString()).Any(a => a == item.id.ToString()) ?? false;
                                if (watched)
                                {
                                    <Blazorise.Icon Name="FontAwesomeIcons.Eye" IconSize="IconSize.x2" TextColor="TextColor.Light"
                                                    Style="position: absolute; bottom: 2px; right: 5px; z-index: 1;"></Blazorise.Icon>
                                }

                                <CardImage Source="@(TmdbOptions.SmallPosterPath + item.poster_path)" Alt="@item.title" title="@item.title" Style=@($"cursor: pointer; {(watched ? "filter: grayscale(100%);" : "")}")></CardImage>
                            }
                        </Blazorise.Link>

                        <CardBody Class="py-1">
                            @item.title
                        </CardBody>
                    </Card>
                </Column>
            }
        </Row>
    </RenderControl>
</ModalBody>
<ModalFooter>
    <Button Color="Color.Primary" Size="Size.Small" Clicked="@Watched" Float="Float.Start" title="Mark all these items as watched">@GlobalTranslations.ButtonWatched</Button>
    <Button Color="Color.Danger" Size="Size.Small" Clicked="@RemoveCollection" Float="Float.Start" title="Remove this collection from my list">@GlobalTranslations.RemoveCollection</Button>
    <Button Color="Color.Secondary" Size="Size.Small" Clicked="@HideModal" Float="Float.End">@GlobalTranslations.ButtonClose</Button>
</ModalFooter>

@code {
    [Inject] public IModalService ModalService { get; set; } = default!;

    [Parameter] public string? collection_id { get; set; }
    [Parameter] public MediaType? type { get; set; }

    private TmdbCollection? collection { get; set; }

    private WatchedList? WatchedList;
    private WatchingList? WatchingList;
    private WishList? WishList;

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(collection_id)) throw new ArgumentNullException(nameof(collection_id));
        if (type == null) throw new ArgumentNullException(nameof(type));

        AppState.WatchedListChanged += (WatchedList? list) => { WatchedList = list; StateHasChanged(); };
        AppState.WatchingListChanged += (WatchingList? list) => { WatchingList = list; StateHasChanged(); };
        AppState.WishListChanged += (WishList? list) => { WishList = list; StateHasChanged(); };
    }

    protected override async Task LoadDataRender()
    {
        if (await AppState.IsUserAuthenticated())
        {
            WatchedList = await AppState.GetWatchedList(false);
            WatchingList = await AppState.GetWatchingList(false);
            WishList = await AppState.GetWishList(false);
        }        
    }

    protected async Task<bool> Loadcollection()
    {
        if (type == MediaType.movie)
        {
            var parameters = new Dictionary<string, string>()
            {
                { "api_key", TmdbOptions.ApiKey },
                { "language", AppStateStatic.Language.GetName(false) ?? "en-US" }
            };

            collection = await TmdbApi.GetCollection(collection_id, parameters);
        }
        else
        {
            var show = await TmdbApi.GetMediaDetail(collection_id, MediaType.tv);

            collection = new TmdbCollection();
            collection.id = int.Parse(show.tmdb_id ?? "0");
            collection.name = show.title ?? "error";

            foreach (var season in show.Collection)
            {
                collection.parts.Add(new Part
                    {
                        id = int.Parse(season.id ?? "0"),
                        season_number = season.SeasonNumber,
                        title = season.title ?? "error",
                        release_date = season.release_date.ToString() ?? "",
                        poster_path = string.IsNullOrEmpty(season.poster_small) ? "" : TmdbOptions.SmallPosterPath + season.poster_small
                    });
            }
        }

        return collection == null;
    }

    public async Task HideModal()
    {
        await ModalService.Hide();
    }

    private async Task CollectionClicked(Part? item)
    {
        if (type == MediaType.movie)
            await OpenPopupMedia(item, type);
        else
            await OpenPopupSeason(item);
    }

    private async Task OpenPopupMedia(Part? part, MediaType? mediaType)
    {
        await ModalService.Show<MediaPopup>(part?.title,
            x =>
            {
                x.Add(x => x.tmdb_id, part?.id.ToString());
                x.Add(x => x.type, mediaType);
            },
            new ModalInstanceOptions()
                {
                    UseModalStructure = false,
                    Centered = true,
                    Size = ModalSize.Large,
                });
    }

    private async Task OpenPopupSeason(Part? part)
    {
        await ModalService.Show<SeasonPopup>(null,
            x =>
            {
                x.Add(x => x.ShowTitle, collection?.name);
                x.Add(x => x.ShowSeasonName, part?.title);
                x.Add(x => x.tmdb_id, collection_id);
                x.Add(x => x.season_number, part?.season_number);
            },
            new ModalInstanceOptions()
                {
                    UseModalStructure = false,
                    Centered = true,
                    Size = ModalSize.Large,
                });
    }

    private async Task Watched()
    {
        await ModalService.Show<SelectItemsCollection>(null,
            x =>
            {
                x.Add(x => x.ItemsCollection, collection?.parts.Select(s => TmdbApi.ConvertToCollection(s)).ToList());
                x.Add(x => x.SelectedItems, WatchingList?.GetWatchedItems(type, collection?.id.ToString()).ToHashSet()); //ToHashSet = clone to not reference
                x.Add(x => x.SelectedItemsChanged,
                    new EventCallbackFactory().Create(this, async (HashSet<string> list) => await SelectedItemsChanged(type, collection, collection_id, list, collection?.parts.Count ?? 0)));
            },
            new ModalInstanceOptions()
                {
                    UseModalStructure = false,
                    Centered = true,
                    Size = ModalSize.Default,
                });
    }

    private async Task SelectedItemsChanged(MediaType? type, TmdbCollection? collection, string? tmdb_id, HashSet<string> items, int collectionItemsCount)
    {
        if (type == null) throw new ArgumentNullException(nameof(type));

        //watched list

        if (type == MediaType.movie)
        {
            WatchedList = await WatchedListApi.Add(type, string.Join(',', items));

            AppState.ChangeWatchedList(WatchedList);
        }

        //watching list

        WatchingListItem item;

        if (type == MediaType.movie)
        {
            item = new WatchingListItem(collection?.id.ToString(), collection?.name, collection?.poster_path?.Replace(TmdbOptions.SmallPosterPath, ""), collectionItemsCount, items);
        }
        else
        {
            var media = await TmdbApi.GetMediaDetail(tmdb_id, type);

            item = new WatchingListItem(tmdb_id, media?.title, media?.poster_small?.Replace(TmdbOptions.SmallPosterPath, ""), collectionItemsCount, items);
        }

        WatchingList = await WatchingListApi.Add(type, item);

        AppState.ChangeWatchingList(WatchingList);

        await HideModal();
    }

    private async Task RemoveCollection()
    {
        var watching = await AppState.GetWatchingList(false) ?? new WatchingList();

        watching = await WatchingListApi.Remove(type, collection_id);

        AppState.ChangeWatchingList(watching);

        await HideModal();
    }
}